# Multi-stage build: 第一阶段编译依赖，第二阶段运行时
# 基础：Alpine Linux for minimal size

# Stage 1: Builder
FROM alpine:3.20 AS builder

# 安装构建工具和依赖（最小化）
RUN apk add --no-cache --update \
    git \
    make \
    gcc \
    g++ \
    musl-dev \
    cmake \
    autoconf \
    automake \
    libtool \
    pkgconfig \
    libusb-dev \
    python3-dev \
    py3-pip \
    sox \
    && rm -rf /var/cache/apk/*

# 克隆并编译 SoftMBE (dsd + mbelib)
WORKDIR /tmp/softmbe
RUN git clone https://github.com/szechyjs/dsd.git . \
    && git clone https://github.com/szechyjs/mbelib.git mbelib \
    && mkdir build && cd build \
    && cmake .. -DCMAKE_INSTALL_PREFIX=/usr -DWITH_DSDCC=ON -DWITH_MBELIB=ON \
    && make -j$(nproc) && make install \
    && cd .. && rm -rf build mbelib

# 编译 csdr (DSP 库)
WORKDIR /tmp/csdr
RUN git clone https://github.com/simonyiszk/csdr.git . \
    && make all && make install \
    && rm -rf /tmp/csdr

# 编译 Dire Wolf (见第2部分，更新到1.8.1)
WORKDIR /tmp/direwolf
RUN git clone https://github.com/wb2osz/direwolf.git . \
    && git checkout 1.8.1 \
    && make -j$(nproc) \
    && make install \
    && rm -rf /tmp/direwolf

# 安装 OpenWebRX 依赖并克隆
RUN apk add --no-cache \
    python3 \
    py3-numpy \
    py3-websockets \
    libffi-dev \
    openssl-dev \
    && pip install --no-cache-dir twisted cherrypy soapy-lite soapysdr-module-uhd \
    && git clone https://github.com/jketterl/openwebrx.git /opt/openwebrx \
    && cd /opt/openwebrx && pip install --no-cache-dir -r requirements.txt

# Stage 2: Runtime
FROM alpine:3.20

# 安装运行时依赖（最小）
RUN apk add --no-cache \
    python3 \
    sox \
    libusb \
    libgcc \
    && adduser -D openwebrx -h /opt/openwebrx

# 从 builder 复制编译产物
COPY --from=builder /usr/bin/dsd /usr/bin/dsd
COPY --from=builder /usr/lib/libmbe* /usr/lib/
COPY --from=builder /usr/bin/csdr /usr/bin/csdr
COPY --from=builder /usr/bin/direwolf /usr/bin/direwolf
COPY --from=builder /opt/openwebrx /opt/openwebrx

# 复制配置文件（假设你有 config_webrx.py 模板）
# COPY config_webrx.py /opt/openwebrx/config_webrx.py

WORKDIR /opt/openwebrx
USER openwebrx

# 暴露端口
EXPOSE 8073

# 启动脚本（假设有 start.sh，或用 python 直接跑）
CMD ["python", "openwebrx.py"]
